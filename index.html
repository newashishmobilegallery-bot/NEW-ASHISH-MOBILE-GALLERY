<script>
/* ===============================
   CONFIG
================================ */
const API_URL = "https://script.google.com/macros/s/AKfycbw1HL3q0u-dFGrxF71ONDgUOpv4Xs2G5G53cEVmSHSDlOKNMjzSr8wISOeiquN_MFg0/exec";
let products = [];
let cart = [];

/* ===============================
   DOM ELEMENTS
================================ */
const productGrid = document.getElementById("product-grid");
const cartCount = document.getElementById("cart-count");
const cartPanel = document.getElementById("cart-panel");
const cartModal = document.getElementById("cart-modal");

/* ===============================
   FETCH PRODUCTS FROM GOOGLE SHEET
================================ */
async function loadProducts() {
  try {
    const res = await fetch(API_URL);
    const data = await res.json();

    products = data
      // ❌ REMOVE APPLE
      .filter(p => p.Brand?.toLowerCase() !== "apple")
      // ❌ REMOVE OUT OF STOCK
      .filter(p => p["Stock Status (In Stock / Out of Stock)"] === "In Stock")
      // MAP TO WEBSITE FORMAT
      .map(p => ({
        id: p["Product ID (unique)"],
        name: p["Product Name"],
        category: p.Brand,
        status: p["Popular Product (Yes / No)"] === "Yes" ? "Popular" : "In Stock",
        img: p["Product Image URL"] !== "[URL]" ? p["Product Image URL"] : null
      }));

    renderProducts();
  } catch (err) {
    console.error("Failed to load products", err);
    productGrid.innerHTML = "<p class='text-center text-red-500'>Failed to load products.</p>";
  }
}

/* ===============================
   RENDER PRODUCTS
================================ */
function renderProducts(filter = "all") {
  productGrid.innerHTML = "";

  const filtered = filter === "all"
    ? products
    : products.filter(p => p.category === filter);

  filtered.forEach(product => {
    const card = document.createElement("div");
    card.className = "bg-white rounded-2xl p-4 border border-gray-100 product-card flex flex-col h-full";

    card.innerHTML = `
      <div class="relative w-full pt-[100%] rounded-xl bg-gray-900 mb-4 overflow-hidden flex items-center justify-center">
        ${
          product.img
            ? `<img src="${product.img}" alt="${product.name}" class="absolute inset-0 w-full h-full object-cover">`
            : `<i class="fa-solid fa-mobile-screen text-4xl text-white opacity-40"></i>`
        }
      </div>

      <div class="flex-grow">
        <h3 class="font-bold text-lg text-gray-900">${product.name}</h3>
        <span class="inline-block bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded mt-2">${product.status}</span>
      </div>

      <div class="flex items-center justify-between mt-4 border-t pt-4">
        <span class="text-sm font-bold text-brand-600 cursor-pointer" onclick="location.href='#location'">
          Visit Store
        </span>
        <button onclick="addToCart('${product.id}')" class="bg-gray-900 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-brand-600">
          <i class="fa-solid fa-plus"></i>
        </button>
      </div>
    `;
    productGrid.appendChild(card);
  });
}

/* ===============================
   FILTER BUTTON HANDLER
================================ */
function filterProducts(category, btn) {
  renderProducts(category);
  btn.parentElement.querySelectorAll("button").forEach(b => {
    b.className = "px-6 py-2 rounded-lg text-sm font-medium text-gray-600 hover:text-brand-600 hover:bg-gray-50";
  });
  btn.className = "px-6 py-2 rounded-lg text-sm font-medium bg-brand-600 text-white";
}

/* ===============================
   WISHLIST
================================ */
function addToCart(id) {
  if (!cart.includes(id)) cart.push(id);
  cartCount.innerText = cart.length;
  toggleCart();
}

function toggleCart() {
  cartModal.classList.toggle("hidden");
}

/* ===============================
   INIT
================================ */
loadProducts();
</script>
